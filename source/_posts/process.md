title: 进程、线程
author: Laiyong Wang
date: 2024-05-09 14:23:34
tags:
---
1. 什么是进程和线程
  - 大意
  进程是资源分配的基本单位，线程是资源调度的基本单位
  - 详细信息（官方话，看着头疼，下面我来解释下）
    - 进程：操作系统对一个正在运行的程序的一种抽象，在一个系统上可以同时运行多个进程，而每个进程都好像在独占地使用硬件。所谓的并发运行，则是说一个进程的指令和另一个进程的指令是交错执行的。无论是在单核还是多核系统中，可以通过处理器在进程间切换，来实现单个 CPU 看上去像是在并发地执行多个进程。操作系统实现这种交错执行的机制称为上下文切换
    - 线程：进程实际上可以由多个称为线程的执行单元组成，每个线程都运行在进程的上下文中，并共享同样的代码和全局数据。进程的个体间是完全独立的，而线程间是彼此依存的。多进程环境中，任何一个进程的终止，不会影响到其他进程。而多线程环境中，父线程终止，全部子线程被迫终止(没有了资源)。

2. 进程
  - 数据结构
  task_struct 详情请看 https://zhuanlan.zhihu.com/p/173810046
  写这个只是为了接下来写线程与进程的关系服务，作为开发，不懂最基础的原理可以，但是基本理论、逻辑和关系还是得懂的
  - 状态
  创建状态、就绪状态、运行状态、阻塞状态、结束状态，除了创建和结束，其余三个状态使根据情况自行切换的
  其中就绪状态和阻塞状态的进程较多时会大量占用内存，所以会将其写入磁盘，又会有刮起挂起状态，分别有就绪挂起状态、阻塞挂起状态
  上述的状态切换涉及到了 io 多路复用的原理，看这个文章
  http://laiyong.wang/2022/07/14/I-O
  
  - fork
  复制进程并生成一个新的进程，这个跟 fastCGI 有关，复制肯定比创建快 CGI。
  
  - 进程的上下文切换
  原理就算了，得研究CPU，看了下不好理解也不好写
  这个东西也就是状态那一栏说的，状态之间的切换的基本原理


3. 线程
  - 数据结构
  也是 task_struct ，共享进程的大部分资源，因为数据结构一样且是进程的一部分，所以线程也被称为轻量级进程
  共享部分：代码段（Code Segment）、数据段（Data Segment、堆（Heap）、文件描述符、套接字和端口、进程标识信息、信号处理器（Signal Handlers）、环境变量、程序计数器（Program Counter）、用户ID和组ID
  不共享部分：栈（Stack）、寄存器状态（Register States）、线程优先级和调度、线程局部存储（Thread-Local Storage）、线程ID
  不共享部分正好可以判断唯一性，且还有优先度啥的，牛逼
  - 状态
  创建状态、就绪状、运行状态、阻塞状态、结束状态，除了创建和结束，其余三个状态使根据情况自行切换的
  
  - fork
  跟进程一样
  
  - 线程的上下文切换
  跟进程一样，若是一个进程只有一个线程，但是可以认为线程等于进程，拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源，这些资源在上下文切换时是不需要修改的
  - 类型
  用户线程、内核线程、轻量级进程。
  用户线程系统开销小，内核线程系统开销大，轻量级进程算是内核支持的用户线程
  用户线程跟协程很类似：查了下资料https://zhuanlan.zhihu.com/p/687843639
  主要是调度方式和资源消耗的在差别，协程的调度和资源消耗都不需要系统参与，所以可以节省系统资源
  
  
4. 线程与进程的比较
  进程是资源（包括内存、打开的文件等）分配的单位，线程是 CPU 调度的单位；
  进程拥有一个完整的资源平台，而线程只独享必不可少的资源，如寄存器和栈；
  线程同样具有就绪、阻塞、执行三种基本状态，同样具有状态之间的转换关系；
  线程能减少并发执行的时间和空间开销；
  为啥线程能减少并发的时间和空间开销
  1、线程共享进程的很多东西，所以创建、销毁都会少很多信息需要处理，会更快
  2、线程切换时使用的都是进程的虚拟内存，所以不需要切换页表，所以也比进程切换的速度快
  3、同一进程的各线程间共享内存和文件资源，在线程之间数据传递时就不需要经过内核，这就使得线程之间的数据交互效率更高
  结论：不管是时间效率，还是空间效率线程比进程都要高
5. 多线程冲突
  因为线程共享了资源，多线程同时操作相同变量时，会发生好玩的事情，类似于缓存一致性的问题
  解决方法：
  1、锁：同一时间，同一个数据只有一个线程可使用
  2、同步：线程串行执行
  
6. 死锁
  看另外一个文章：
